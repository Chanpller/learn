# 第20章-性能监控与调优-概述

## 20.1 大厂面试题

* 支付宝
  * 支付宝三面：JVM性能调优都做了什么？
* 小米
  * 有做过JVM内存优化吗？
  * 从SQL、JVM、架构、数据库四个方面讲讲优化思路
* 蚂蚁金服
  * JVM的编译优化
  * JVM性能调优都做了什么
  * JVM诊断调优工具用过哪些？
  * 二面：jvm怎样调优，堆内存、栈空间设置多少合适
  * 三面：JVM相关的分析工具使用过的有哪些？具体的性能调优步骤如何
* 阿里
  * 如何进行JVM调优？有哪些方法？
  * 如何理解内存泄漏问题？有哪些情况会导致内存泄漏？如何解决？
* 字节跳动
  * 三面：JVM如何调优、参数怎么调？
* 拼多多
  * 从SQL、JVM、架构、数据库四个方面讲讲优化思路
* 京东
  * JVM诊断调优工具用过哪些？
  * 每秒几十万并发的秒杀系统为什么会频繁发生GC？
  * 日均百万级交易系统如何优化JVM？
  * 线上生产系统OOM如何监控及定位与解决？
  * 高并发系统如何基于G1垃圾回收器优化性能？

## 20.2 背景说明

### 20.2.1 生产环境中的问题

* 生产环境发生内存溢出该如何处理？
* 生产环境应该给服务器分配多少内存合适？
* 如何对垃圾回收器的性能进行调优？
* 生产环境VPU负载飙高该如何处理？
* 生产环境应该给应用分配多少线程合适？
* 不加log，如何确定请求是否执行了某一行代码？
* 不加log，如何实时查看某个方法的入参与返回值？

### 20.2.2 为什么要调优

* 防止出现OOM
* 解决OOM
* 减少Full GC出现的频率

### 20.2.3 不同阶段的考虑

* 上线前
* 项目运行阶段
* 线上出现OOM

## 20.3 调优概述

### 20.3.1 监控的依据

* 运行日志
* 异常堆栈
* GC日志
* 线程快照
* 堆转储快照

### 20.3.2 调优的大方向

* 合理的编写代码
* 充分并合理的使用硬件资源
* 合理地进行JVM调优

## 20.4 性能优化的步骤

### 20.4.1 性能监控（第一步发现问题）

一种非强行或者入侵方式收集或查看应用运营性能数据的活动。监控通常是指一种在生产、质量评估或则开发环境下实时的带有预防或主动性的活动。当应用相关干系人提出性能问题却没有提供足够多的线索时，首先我们需要进行性能监控，随后时性能分析。

* GC频繁
* CPU load过高
* OOM
* 内存泄漏
* 死锁
* 程序相应时间长

### 20.4.2 性能分析（第二步排查问题）

* 打印GC日志，通过GC viewer或者http://gceasy.io来分析日志信息
* 灵活运用命令行工具，jstack，jmap，jinfo
* dump出堆文件，使用内存分析工具分析文件
* 使用阿里Arthas，或jsonsole，JVisualVM来试试查看JVM状态
* jstack查看堆栈信息

### 20.4.3 性能调优（第三步解决问题）

一种为改善应用响应性或吞吐量而更改参数、源代码、属性配置的活动，性能调优是在性能监控、性能分析之后的活动。

* 适当增加内存，根据业务背景选择垃圾回收器
* 优化代码，控制内存使用
* 增加机器，分散节点压力
* 合理设置线程池线程数量
* 使用中间件提高效率，比如缓存、消息队列等
* 其他

## 20.5 性能评估/测试指标

* 停顿时间（或响应时间）
  * 提交请求和返回该请求的响应之间使用的时间，一般比较关注平均响应时间
  * 常用操作的响应时间列表

| 操作                              | 响应时间 |
| --------------------------------- | -------- |
| 打开一个站点                      | 几秒     |
| 数据库查询一条记录（有索引）      | 十几毫秒 |
| 机械磁盘一次寻址定位              | 4毫秒    |
| 从机械磁盘顺序读取1M数据          | 2毫秒    |
| 从SSD磁盘顺序读取1M数据           | 0.3毫秒  |
| 从远程分布式换成Redis读取一个数据 | 0.5毫秒  |
| 从内存读取1M数据                  | 十几微秒 |
| Java程序本地方法调用              | 几微秒   |
| 网络传输2kb数据                   | 1微秒    |

在垃圾回收环节中：暂停时间=执行垃圾收集时，程序的工作线程都被暂停的时间。可以用-XX:MaxGCPauseMillis参数设置，也是看情况生效。

* 吞吐量
  * 对单位时间内完成的工作量（请求）的量度
  * 在GC中：运行用户代码的时间占总运行时间的比例（总运行时间：程序的运行时间+内存回收的时间），吞吐量为1-1/(1+n)。-XX:GCtimeRatio=n
* 并发数
  * 同一时刻，对服务器有实际交互的请求数
* 内存占用
  * Java堆区所占的内存大小
* 相互间的关系
  * 吞吐量越大，并发量越大，响应时间也越慢